<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>beGAK.com - Ayarlar</title>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../shared/theme.css">
    <link rel="stylesheet" href="ayarlar_style.css">
    <script src="../shared/theme.js"></script>
    <script>
        // Sayfa yüklenmeden önce tema ayarını al
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="brand">
            <div class="brand-logo">
                <img src="/main/images/begakkom_logo (1).svg" alt="beGAKKOM Logo" class="logo-image">
            </div>
            <a href="../anasayfa/anasayfa_screen.html" class="brand-name">beGAK.com</a>
        </div>
        <div class="nav-links">
            <a href="../anasayfa/anasayfa_screen.html"><i class="fas fa-home"></i> Ana Sayfa</a>
            <a href="../sosyal_etkinlikler/sosyal_etkinlikler_screen.html"><i class="fas fa-calendar-alt"></i> Sosyal Etkinlikler</a>
            <a href="../profil/profil_screen.html"><i class="fas fa-user"></i> Profil</a>
            <a href="../mesajlar/mesajlar_screen.html"><i class="fas fa-envelope"></i> Mesajlar</a>
            <a href="../kulupler/kulupler_screen.html"><i class="fas fa-users"></i> Kulüpler</a>
            <a href="../ayarlar/ayarlar_screen.html" class="active"><i class="fas fa-cog"></i> Ayarlar</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="settings-container">
            <h2 class="settings-title">
                <i class="fas fa-cog"></i> Hesap Ayarları
            </h2>

            <div class="settings-section">
                <div class="settings-card">
                    <form id="settings-form">
                        <div class="form-group">
                            <label for="firstName">Ad</label>
                            <input type="text" id="firstName" name="firstName" class="form-control" placeholder="Adınız">
                        </div>
                        <div class="form-group">
                            <label for="lastName">Soyad</label>
                            <input type="text" id="lastName" name="lastName" class="form-control" placeholder="Soyadınız">
                        </div>
                        <div class="form-group">
                            <label for="email">E-posta</label>
                            <input type="email" id="email" name="email" class="form-control" placeholder="E-posta adresiniz" readonly>
                        </div>
                        <div class="form-group">
                            <label for="studentNumber">Öğrenci Numarası</label>
                            <input type="text" id="studentNumber" name="studentNumber" class="form-control" placeholder="Öğrenci numaranız" readonly>
                        </div>
                        <div class="form-group">
                            <label for="department">Bölüm</label>
                            <input type="text" id="department" name="department" class="form-control" placeholder="Bölümünüz">
                        </div>
                        <div class="form-group">
                            <label for="yearOfStudy">Sınıf</label>
                            <select id="yearOfStudy" name="yearOfStudy" class="form-control">
                                <option value="1">1. Sınıf</option>
                                <option value="2">2. Sınıf</option>
                                <option value="3">3. Sınıf</option>
                                <option value="4">4. Sınıf</option>
                                <option value="5">5. Sınıf</option>
                                <option value="6">6. Sınıf</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="save-button" onclick="saveSettings()">Değişiklikleri Kaydet</button>
                        </div>
                    </form>
                </div>

                <div class="settings-card">
                    <h3 class="card-title">Şifre Değiştir</h3>
                    <form id="password-form">
                        <div class="form-group">
                            <label for="currentPassword">Mevcut Şifre</label>
                            <div class="password-input-group">
                                <input type="password" id="currentPassword" name="currentPassword" class="form-control" placeholder="Mevcut şifreniz">
                                <button type="button" class="show-password-btn" onclick="togglePasswordVisibility('currentPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Yeni Şifre</label>
                            <div class="password-input-group">
                                <input type="password" id="newPassword" name="newPassword" class="form-control" placeholder="Yeni şifreniz">
                                <button type="button" class="show-password-btn" onclick="togglePasswordVisibility('newPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Yeni Şifre (Tekrar)</label>
                            <div class="password-input-group">
                                <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" placeholder="Yeni şifrenizi tekrar girin">
                                <button type="button" class="show-password-btn" onclick="togglePasswordVisibility('confirmPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="save-button" onclick="changePassword()">Şifreyi Değiştir</button>
                        </div>
                    </form>
                </div>

                <div class="settings-card">
                    <h3 class="card-title">Tema Ayarları</h3>
                    <div class="theme-settings">
                        <div class="theme-option">
                            <span>Karanlık Tema</span>
                            <label class="switch">
                                <input type="checkbox" id="darkModeToggle">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <p class="theme-description">
                            Karanlık tema kullanarak göz yorgunluğunu azaltabilir ve gece kullanımında daha rahat edebilirsiniz.
                        </p>
                        <div class="form-actions">
                            <button type="button" class="save-button" onclick="applyThemeChange()">Temayı Uygula</button>
                        </div>
                    </div>
                </div>

                <div class="settings-card danger-zone">
                    <h3 class="card-title">Hesap İşlemleri</h3>
                    <div class="danger-actions">
                        <button class="logout-button" onclick="handleLogout()">
                            <i class="fas fa-sign-out-alt"></i> Çıkış Yap
                        </button>
                        <button class="delete-account-button" onclick="deleteAccount()">
                            <i class="fas fa-user-slash"></i> Hesabı Sil
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bildirim Bileşeni -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <i class="fas fa-check-circle"></i>
            <span id="notification-message"></span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Oturum kontrolü
            checkSession();
            
            // Kullanıcı bilgilerini yükle
            loadUserSettings();
            
            // Tema ayarı kontrolü ve toggle butonunu ayarla
            setupThemeToggle();
        });

        // Tema ayarlarını kontrol et ve toggle butonunu ayarla
        function setupThemeToggle() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const currentTheme = localStorage.getItem('theme');
            
            if (currentTheme === 'dark') {
                darkModeToggle.checked = true;
            } else {
                darkModeToggle.checked = false;
            }
        }

        // Tema değişikliğini uygula (Uygula butonuna tıklandığında)
        function applyThemeChange() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const desiredTheme = darkModeToggle.checked ? 'dark' : 'light';
            const currentTheme = localStorage.getItem('theme');
            
            // Eğer mevcut tema ile istenen tema farklıysa değişiklik yap
            if (currentTheme !== desiredTheme) {
                // shared/theme.js'deki changeAndSaveTheme fonksiyonunu kullan
                changeAndSaveTheme(desiredTheme, function(theme) {
                    // Tema başarıyla değiştirildiğinde bu geri çağırma çalışır
                    if (theme === 'dark') {
                        showNotification('Karanlık tema etkinleştirildi ve tüm sayfalara uygulandı', 'success');
                    } else {
                        showNotification('Aydınlık tema etkinleştirildi ve tüm sayfalara uygulandı', 'success');
                    }
                    
                    // Diğer sayfaları da güncelle
                    if (window.frames && window.frames.length > 0) {
                        for (let i = 0; i < window.frames.length; i++) {
                            try {
                                window.frames[i].document.documentElement.setAttribute('data-theme', theme);
                            } catch (e) {
                                console.warn('Farklı kaynaktaki iframe güncellenemedi:', e);
                            }
                        }
                    }
                });
            } else {
                showNotification('Tema zaten uygulanmış durumda', 'success');
            }
        }

        // Oturum kontrolü
        function checkSession() {
            const authToken = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            
            if (!authToken || !user) {
                window.location.href = '../login/login_screen.html';
            }
        }

        // Kullanıcı ayarlarını yükle
        async function loadUserSettings() {
            try {
                // Kullanıcı email'ini localStorage'dan al
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const email = user.email;
                
                if (!email) {
                    showNotification('Kullanıcı bilgileri bulunamadı', 'error');
                    window.location.href = '../login/login_screen.html';
                    return;
                }
                
                // API'den profil verilerini çek
                const response = await fetch(`/api/profile?email=${email}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.user) {
                    // Form alanlarını doldur
                    const userInfo = data.user;
                    document.getElementById('firstName').value = userInfo.firstName || '';
                    document.getElementById('lastName').value = userInfo.lastName || '';
                    document.getElementById('email').value = userInfo.email || '';
                    document.getElementById('studentNumber').value = userInfo.studentNumber || '';
                    document.getElementById('department').value = userInfo.department || '';
                    
                    const yearSelect = document.getElementById('yearOfStudy');
                    if (userInfo.yearOfStudy) {
                        yearSelect.value = userInfo.yearOfStudy;
                    }
                    
                    // localStorage'daki kullanıcı bilgilerini güncelle
                    localStorage.setItem('user', JSON.stringify(userInfo));
                } else {
                    // API başarısız olursa, localStorage'daki verileri kullan
                    document.getElementById('firstName').value = user.firstName || '';
                    document.getElementById('lastName').value = user.lastName || '';
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('studentNumber').value = user.studentNumber || '';
                    document.getElementById('department').value = user.department || '';
                    
                    const yearSelect = document.getElementById('yearOfStudy');
                    if (user.yearOfStudy) {
                        yearSelect.value = user.yearOfStudy;
                    }
                    
                    console.warn('API verisi alınamadı, localStorage kullanılıyor');
                }
            } catch (error) {
                console.error('Kullanıcı bilgileri yüklenirken hata:', error);
                showNotification('Kullanıcı bilgileri yüklenirken bir hata oluştu', 'error');
                
                // Hata durumunda, localStorage'daki verileri kullan
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                document.getElementById('firstName').value = user.firstName || '';
                document.getElementById('lastName').value = user.lastName || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('studentNumber').value = user.studentNumber || '';
                document.getElementById('department').value = user.department || '';
                
                const yearSelect = document.getElementById('yearOfStudy');
                if (user.yearOfStudy) {
                    yearSelect.value = user.yearOfStudy;
                }
            }
        }

        // Ayarları kaydet
        async function saveSettings() {
            try {
                const formData = {
                    email: document.getElementById('email').value,
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    department: document.getElementById('department').value,
                    yearOfStudy: document.getElementById('yearOfStudy').value
                };
                
                console.log('Kaydedilecek veriler:', formData);
                
                // API'ye istek gönder
                const response = await fetch('/api/user/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Kullanıcı bilgilerini localStorage'da güncelle
                    let user = JSON.parse(localStorage.getItem('user') || '{}');
                    user = { ...user, ...formData };
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    showNotification('Ayarlarınız başarıyla kaydedildi', 'success');
                } else {
                    throw new Error(data.message || 'Ayarlar kaydedilemedi');
                }
            } catch (error) {
                console.error('Ayarlar kaydedilirken hata:', error);
                showNotification(error.message || 'Ayarlar kaydedilirken bir hata oluştu', 'error');
            }
        }

        // Şifre değiştir
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // Form doğrulama
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showNotification('Lütfen tüm alanları doldurun', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showNotification('Yeni şifreler eşleşmiyor', 'error');
                    return;
                }
                
                if (newPassword.length < 6) {
                    showNotification('Yeni şifre en az 6 karakter olmalıdır', 'error');
                    return;
                }
                
                // Kullanıcı bilgilerini al
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const email = user.email;
                
                if (!email) {
                    showNotification('Kullanıcı bilgileri bulunamadı', 'error');
                    return;
                }
                
                // Şifre değiştirme isteği gönder
                const response = await fetch('/api/user/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        email: email,
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Şifre değiştirme başarılı
                    document.getElementById('password-form').reset();
                    showNotification('Şifreniz başarıyla değiştirildi', 'success');
                } else {
                    // API'den hata mesajı döndüyse onu göster
                    showNotification(data.message || 'Şifre değiştirilemedi', 'error');
                }
            } catch (error) {
                console.error('Şifre değiştirilirken hata:', error);
                showNotification('Şifre değiştirilirken bir hata oluştu', 'error');
            }
        }

        // Çıkış yap
        function handleLogout() {
            if (confirm('Çıkış yapmak istediğinize emin misiniz?')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                localStorage.removeItem('userData');
                localStorage.removeItem('userEmail');
                window.location.href = '../login/login_screen.html';
            }
        }

        // Hesabı sil
        async function deleteAccount() {
            if (confirm('Hesabınızı silmek istediğinize emin misiniz? Bu işlem geri alınamaz!')) {
                if (confirm('Tüm verileriniz silinecek. Devam etmek istiyor musunuz?')) {
                    try {
                        // Kullanıcı bilgilerini al
                        const user = JSON.parse(localStorage.getItem('user') || '{}');
                        const email = user.email;
                        
                        if (!email) {
                            showNotification('Kullanıcı bilgileri bulunamadı', 'error');
                            return;
                        }
                        
                        // Hesap silme isteği gönder
                        const response = await fetch('/api/user/delete-account', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                            },
                            body: JSON.stringify({ email })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showNotification('Hesabınız başarıyla silindi', 'success');
                            
                            // Oturum bilgilerini temizle
                            localStorage.removeItem('authToken');
                            localStorage.removeItem('user');
                            localStorage.removeItem('userData');
                            localStorage.removeItem('userEmail');
                            
                            // Kullanıcıyı login sayfasına yönlendir
                            setTimeout(() => {
                                window.location.href = '../login/login_screen.html';
                            }, 1500);
                        } else {
                            throw new Error(data.message || 'Hesap silinemedi');
                        }
                    } catch (error) {
                        console.error('Hesap silinirken hata:', error);
                        showNotification(error.message || 'Hesap silinirken bir hata oluştu', 'error');
                    }
                }
            }
        }

        // Şifre görünürlüğünü değiştir
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Bildirim göster
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const icon = notification.querySelector('i');
            const messageEl = notification.querySelector('#notification-message');
            
            // İkon ve sınıf ayarla
            notification.className = 'notification';
            notification.classList.add(type);
            
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
            } else {
                icon.className = 'fas fa-exclamation-circle';
            }
            
            messageEl.textContent = message;
            
            // Bildirimi göster
            notification.classList.add('show');
            
            // Belirli bir süre sonra bildirimi gizle
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html> 